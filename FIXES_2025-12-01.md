# RangerPlex AI Fixes - December 1, 2025

## Overview
This document details fixes applied to resolve console errors in RangerPlex AI, specifically addressing sync service spam and radio player 403 errors.

---

## Issue 1: Sync Service Console Spam

### Problem
When the sync server (`localhost:3000`) is not running, the app floods the console with connection errors:
- `WebSocket connection to 'ws://localhost:3000/' failed: net::ERR_CONNECTION_REFUSED`
- `POST http://localhost:3000/api/sync/chat net::ERR_CONNECTION_REFUSED`
- `Failed to load resource: net::ERR_CONNECTION_REFUSED` for multiple endpoints
- These errors repeat every few seconds indefinitely

### Root Cause
The `syncService.ts` was attempting to connect and sync regardless of server availability, with no smart backoff or offline detection.

### File Modified
`services/syncService.ts`

### Changes Made

#### 1. Added new class properties for offline handling:
```typescript
private httpBaseUrl = 'http://localhost:3000';
private maxReconnectInterval = 60000; // Max 1 minute between retries
private currentReconnectInterval = 5000;
private serverAvailable = false; // Track if server is reachable
private lastServerCheck = 0;
private serverCheckInterval = 30000; // Check server every 30s when offline
private connectionAttempts = 0;
private maxLoggedAttempts = 3; // Only log first 3 connection failures
```

#### 2. Added server availability check method:
```typescript
private async checkServerAvailability(): Promise<boolean> {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000); // 3s timeout

        const response = await fetch(`${this.httpBaseUrl}/api/health`, {
            method: 'GET',
            signal: controller.signal
        });
        clearTimeout(timeoutId);

        this.serverAvailable = response.ok;
        this.lastServerCheck = Date.now();

        if (this.serverAvailable) {
            this.connectionAttempts = 0;
            this.currentReconnectInterval = this.reconnectInterval;
        }

        return this.serverAvailable;
    } catch {
        this.serverAvailable = false;
        this.lastServerCheck = Date.now();
        return false;
    }
}
```

#### 3. Added smart server check scheduling with exponential backoff:
```typescript
private scheduleServerCheck() {
    if (this.reconnectTimer) return;

    this.reconnectTimer = setTimeout(async () => {
        this.reconnectTimer = null;
        const available = await this.checkServerAvailability();
        if (available) {
            console.log('üîå Server became available, connecting...');
            this.connect();
        } else {
            // Exponential backoff for server checks
            this.currentReconnectInterval = Math.min(
                this.currentReconnectInterval * 1.5,
                this.maxReconnectInterval
            );
            this.scheduleServerCheck();
        }
    }, this.currentReconnectInterval);
}
```

#### 4. Updated constructor to check availability before connecting:
```typescript
constructor() {
    this.loadQueue();
    if (typeof window !== 'undefined') {
        this.checkServerAvailability().then(available => {
            if (available) {
                this.connect();
            } else {
                console.log('üì¥ Sync server not available - running in offline mode');
                this.scheduleServerCheck();
            }
        });
    } else {
        console.log('üì¥ Sync service initialized (SSR) - will connect in browser');
    }
}
```

#### 5. Updated `connect()` method to limit logging:
- Only logs first 3 connection failures
- Uses `scheduleServerCheck()` instead of blind reconnect attempts
- Tracks `serverAvailable` state

#### 6. Added `shouldAttemptServerOp()` helper:
```typescript
private shouldAttemptServerOp(): boolean {
    if (!this.serverAvailable && (Date.now() - this.lastServerCheck) < this.serverCheckInterval) {
        return false;
    }
    return true;
}
```

#### 7. Updated all sync methods to be offline-aware:
- `syncChat()` - Returns `{ queued: true }` when offline, silently queues data
- `syncSettings()` - Same behavior
- `getAllChats()` - Returns `[]` when offline
- `getAllSettings()` - Returns `{}` when offline
- Added 5-second timeouts using `AbortController`
- No console.error spam - operations silently queue

#### 8. Added public method to check server status:
```typescript
isServerAvailable(): boolean {
    return this.serverAvailable;
}
```

---

## Issue 2: Radio Player 403 Forbidden Errors

### Problem
SomaFM radio streams returning 403 Forbidden errors:
```
ice1.somafm.com/defcon-128-mp3:1 Failed to load resource: 403 (Forbidden)
RadioPlayer.tsx:567 üìª Audio error: 4 Unknown error
```

### Root Cause
SomaFM's `ice1` server was rejecting requests, likely due to load balancing or geographic restrictions.

### File Modified
`components/RadioPlayer.tsx`

### Changes Made

#### 1. Updated RadioStation interface to support fallbacks:
```typescript
interface RadioStation {
  id: string;
  name: string;
  url: string;
  fallbackUrls?: string[]; // NEW: Fallback stream URLs if primary fails
  genre: string;
  description: string;
  metadataUrl?: string;
}
```

#### 2. Added state to track current URL index:
```typescript
const [currentUrlIndex, setCurrentUrlIndex] = useState(0);
```

#### 3. Added helper function to get all station URLs:
```typescript
const getAllStationUrls = (station: RadioStation): string[] => {
    const urls = [station.url];
    if (station.fallbackUrls) {
        urls.push(...station.fallbackUrls);
    }
    return urls;
};
```

#### 4. Updated memoized stream URL to use current index:
```typescript
const memoizedStreamUrl = useMemo(() => {
    const allUrls = getAllStationUrls(currentStation);
    const urlToUse = allUrls[currentUrlIndex] || allUrls[0];

    if (urlToUse.includes('somafm.com')) {
        return urlToUse;
    }
    return getProxiedUrl(urlToUse);
}, [currentStation.url, currentUrlIndex]);
```

#### 5. Updated error handler to try fallback URLs:
```typescript
const handleAudioError = (e: React.SyntheticEvent<HTMLAudioElement, Event>) => {
    const audio = e.target as HTMLAudioElement;
    const errorCode = audio.error?.code;
    const errorMessage = audio.error?.message || 'Unknown error';
    const allUrls = getAllStationUrls(currentStation);

    // Error code 3 (decode error) - retry same URL
    if (errorCode === 3 && retryCountRef.current < MAX_RETRIES) {
        retryCountRef.current++;
        // ... retry logic with cache-buster
        return;
    }

    // Try fallback URL if available (for 403, 404, or after max retries)
    if (currentUrlIndex < allUrls.length - 1) {
        const nextIndex = currentUrlIndex + 1;
        console.log(`üìª Trying fallback stream ${nextIndex + 1}/${allUrls.length}...`);
        retryCountRef.current = 0;
        setCurrentUrlIndex(nextIndex);

        setTimeout(() => {
            if (audioRef.current) {
                const nextUrl = allUrls[nextIndex];
                const newSrc = nextUrl.includes('somafm.com') ? nextUrl : getProxiedUrl(nextUrl);
                audioRef.current.src = newSrc;
                audioRef.current.load();
                audioRef.current.play().catch(() => {});
            }
        }, 500);
        return;
    }

    // All URLs exhausted - show user-friendly error
    setError('Stream unavailable - try another station');
    // ...
};
```

#### 6. Updated station change handler to reset URL index:
```typescript
const handleStationChange = (stationId: string) => {
    // ...
    setCurrentUrlIndex(0); // Reset to primary URL for new station
    retryCountRef.current = 0;
    setError(null);
    // ...
};
```

#### 7. Updated station definitions with fallback URLs:
Changed primary server from `ice1` to `ice2` (less congested) and added fallbacks:

```typescript
// Example: DEF CON Radio
{
    id: 'soma-defcon',
    name: 'DEF CON Radio',
    url: 'https://ice2.somafm.com/defcon-128-mp3',
    fallbackUrls: [
        'https://ice4.somafm.com/defcon-128-mp3',
        'https://ice6.somafm.com/defcon-128-mp3',
        'https://ice1.somafm.com/defcon-128-mp3'
    ],
    genre: 'Electronic',
    description: 'Music for hacking and coding'
},
```

Stations updated with fallbacks:
- Groove Salad
- Drone Zone
- Deep Space One
- DEF CON Radio

---

## Issue 3: Pre-existing Build Errors (NOT FIXED)

These errors exist in the codebase but are unrelated to the sync/radio issues:

### ranger-chat-lite TypeScript Errors:
```
apps/ranger-chat-lite/electron/main.ts(34,32): error TS2345:
Argument of type 'string | undefined' is not assignable to parameter of type 'string'.

apps/ranger-chat-lite/vite.config.ts(3,22): error TS2307:
Cannot find module 'vite-plugin-electron/simple' or its corresponding type declarations.
```

### Electron CSP Warning (Development Only):
```
Electron Security Warning (Insecure Content-Security-Policy)
This renderer process has either no Content Security Policy set or a policy with "unsafe-eval" enabled.
```
This warning only appears in development and disappears in production builds.

---

## Testing

The dev server (`npm run dev`) starts successfully with these changes. The fixes:
1. Eliminate console spam when sync server is offline
2. Silently queue data for later sync
3. Auto-failover to alternate SomaFM servers when streams fail
4. Use exponential backoff to reduce resource usage when offline

---

## Files Changed Summary

| File | Changes |
|------|---------|
| `services/syncService.ts` | Complete rewrite of connection/sync logic for offline support |
| `components/RadioPlayer.tsx` | Added fallback URL support and automatic failover |

---

## How to Apply to Main Repo (M3Pro)

1. Copy the modified files:
   - `services/syncService.ts`
   - `components/RadioPlayer.tsx`

2. Or apply the changes manually using the descriptions above.

3. The changes are backward compatible - no new dependencies required.

---

## M4Max vs M3Pro Audio Issues (Dec 1, 2025)

### Findings
- **M4Max:** Sound is perfect.
- **M3Pro:** Sound is choppy/distorted ("like someone touching the record"), connection drops.

### Analysis
This discrepancy suggests a difference in how the two machines handle the stream buffering or network latency. The "choppy" sound on the M3Pro indicates buffer underrun or jitter. The "dumb pipe" proxy approach (removing `Readable.fromWeb` overhead) is the proposed solution to standardize performance across both architectures.

### Detailed Radio Player Changes (Reference)
*Clarification: The station dropdown selector was pre-existing. The following changes were made to the internal logic:*

1.  **Interface Update:** Added `fallbackUrls?: string[]` to `RadioStation` interface.
2.  **State Management:** Added `currentUrlIndex` state to track active stream URL.
3.  **Helper Function:** Added `getAllStationUrls` to aggregate primary and fallback URLs.
4.  **Memoization:** Updated `memoizedStreamUrl` to depend on `currentUrlIndex`.
5.  **Error Handling:** Enhanced `handleAudioError` to automatically cycle through `fallbackUrls` upon failure (e.g., 403 Forbidden).
6.  **Station Config:** Updated 4 key stations (Groove Salad, Drone Zone, Deep Space One, DEF CON Radio) to use `ice2` as primary (less congested) and added `ice4`, `ice6`, `ice1` as fallbacks.
7.  **Reset Logic:** Ensured `currentUrlIndex` resets to 0 when manually changing stations.

---

## M3Pro Audio Troubleshooting Log (Dec 1, 2025 - 18:00 UTC)

### Symptoms
- **M4Max:** Audio perfect.
- **M3Pro:** Audio choppy ("like someone touching the record"), connection drops, "Decode error".

### Investigation & Fixes

#### Attempt 1: Phase 1 (Direct Streaming)
- **Action:** Bypassed proxy to stream directly from SomaFM.
- **Result:** Failed with `403 Forbidden`.
- **Conclusion:** Proxy is mandatory due to missing `User-Agent`/`Referer` headers in browser requests.

#### Attempt 2: Phase 2 ("Dumb Pipe" Proxy)
- **Action:** Rewrote proxy to use `https.get` piping instead of `Readable.fromWeb` to reduce overhead.
- **Result:**
    - **Issue A:** "DJ scratching" sound. **Cause:** `Icy-MetaData: 1` header caused server to inject text metadata into audio stream. **Fix:** Removed header.
    - **Issue B:** "Decode error" / stops after 5s. **Cause:** `Transfer-Encoding: identity` with `Connection: keep-alive` is invalid for streams. **Fix:** Removed identity encoding.
    - **Issue C:** `MEDIA_ELEMENT_ERROR: Format error`. **Cause:** Raw piping via `https.get` produced chunking artifacts the browser couldn't handle.

#### Attempt 3: Final Resolution ("Smart Pipe" + Fixes)
- **Action:** Reverted to `Readable.fromWeb` ("Smart Pipe") but applied the critical learnings from Phase 2.
- **Final Configuration:**
    1.  **Implementation:** `fetch` + `Readable.fromWeb` (Node.js stream conversion).
    2.  **CORS:** `Access-Control-Allow-Origin: *` (Required).
    3.  **Stability:** Auto-redirect `ice1.somafm.com` -> `ice2.somafm.com` (Fixes connection drops).
    4.  **Audio Quality:** **REMOVED** `Icy-MetaData: 1` header (Fixes "scratching" sound).
    5.  **Buffering:** `res.flushHeaders()` called immediately.

### Additional Fix: Browser Launch
- **Issue:** `npm run browser` was opening a Chrome tab instead of the Electron app.
- **Cause:** `BROWSER=none` env var not propagating to Vite from background PM2 process.
- **Fix:**
    - `package.json`: Updated dev script to `"dev": "BROWSER=none vite --host"`.
    - `vite.config.ts`: Added `server: { open: false }`.

---

## Issue 4: Radio "Format Error" Bug (Dec 1, 2025 - Evening)

### Problem
```
RadioPlayer.tsx:562 üìª Audio error: 4 MEDIA_ELEMENT_ERROR: Format error
RadioPlayer.tsx:484 Radio play error: NotSupportedError: Failed to load because no supported source was found.
```

### Root Cause
In `proxy_server.js:1568`, the variable `streamUrl` was declared as `const` but later reassigned at line 1604:
```javascript
const streamUrl = req.query.url;  // Line 1568
// ...
streamUrl = streamUrl.replace('ice1.somafm.com', 'ice2.somafm.com');  // Line 1604 - ERROR!
```

This caused the proxy to return `{"error":"Assignment to constant variable."}` instead of audio data.

### Fix
Changed `const` to `let` in `proxy_server.js:1568`:
```javascript
let streamUrl = req.query.url;  // Now allows reassignment
```

---

## Issue 5: RSS Ticker Not Showing Items (Dec 1, 2025 - Evening)

### Problem
RSS ticker only displayed notes, no RSS feed items appeared even though 25/33 feeds were loading.

### Root Cause
`rssService.loadSettings()` returned saved settings objects with an empty `enabledCategories` array. The function didn't merge saved settings with defaults properly.

### Fix
Updated `services/rssService.ts` `loadSettings()` method to merge saved settings with defaults:
```typescript
request.onsuccess = () => {
    const savedSettings = request.result;
    if (!savedSettings) {
        resolve(DEFAULT_RSS_SETTINGS);
        return;
    }
    // Merge saved settings with defaults
    const merged: RSSSettings = {
        ...DEFAULT_RSS_SETTINGS,
        ...savedSettings,
        // Ensure enabledCategories is never empty
        enabledCategories: (savedSettings.enabledCategories && savedSettings.enabledCategories.length > 0)
            ? savedSettings.enabledCategories
            : DEFAULT_RSS_SETTINGS.enabledCategories,
    };
    resolve(merged);
};
```

---

## Issue 6: Broken RSS Feeds (Dec 1, 2025 - Evening)

### Problem
8 RSS feeds were failing with various errors:
- 403 Forbidden (Cloudflare blocking)
- 404 Not Found (Feed moved/removed)
- XML Parse Errors (Malformed feeds)
- Feed Disabled (Site owners disabled RSS)

### Feeds Replaced in `types/rss.ts`

| Old Feed (Broken) | New Feed (Working) | Reason |
|-------------------|-------------------|--------|
| GBHackers on Security | Reddit NetSec | Cloudflare blocking |
| SANS Penetration Testing | SANS ISC | 404 Not Found |
| KitPloit | Rapid7 Blog | XML parse error |
| Hacking Articles | Checkpoint Research | 403 Forbidden |
| Packet Storm | Cisco Talos | Connection failed |
| Sophos Naked Security | SentinelOne Labs | XML parse error |
| Trustwave SpiderLabs | Unit42 Palo Alto | 403 Forbidden |
| Volexity | CrowdStrike Blog | Feed disabled |
| SANS DFIR | Huntress Blog | 404 Not Found |

---

## New Features Added (Dec 1, 2025 - Evening)

### RSS Settings Enhancements

#### New Settings in `types/rss.ts`:
```typescript
displayMode: 'all' | 'rss-only' | 'notes-only' | 'single-category';
singleCategoryFilter?: RSSCategory;
```

#### New Methods in `services/rssService.ts`:
- `resetSettings()` - Reset settings to defaults
- `clearCache()` - Clear in-memory cache
- `clearAllData()` - Delete all RSS data from IndexedDB
- `getStats()` - Get database statistics (feed count, item count, storage usage)
- `refreshAllFeeds()` - Force re-fetch all enabled feeds

#### New UI in `components/SettingsModal.tsx` (RSS Tab):
- **Display Mode Selector**: All / RSS Only / Notes Only / Single Category
- **Single Category Filter**: Filter to one topic when in single-category mode
- **Refresh All Feeds**: Button to force re-fetch all feeds
- **View Database Stats**: See feed counts, cache size, storage usage
- **Clear RSS Cache**: Clear in-memory cache
- **Reset RSS Settings**: Reset to defaults (keeps feeds)
- **Delete All RSS Data**: Nuclear option - deletes everything
- **Clear localStorage**: Reset browser preferences
- **View Storage Info**: See all IndexedDB databases

---

## Files Modified Summary (Evening Session)

| File | Changes |
|------|---------|
| `proxy_server.js` | Fixed `const` ‚Üí `let` for streamUrl variable |
| `services/rssService.ts` | Added settings merge, reset, cache clear, stats methods |
| `types/rss.ts` | Added displayMode, singleCategoryFilter; replaced 9 broken feeds |
| `components/SettingsModal.tsx` | Added new RSS settings UI options |
| `components/RSSNewsTicker.tsx` | Added displayMode and singleCategoryFilter support |
| `CHANGELOG.md` | Updated with all fixes and new features |

---

## Issue 7: RSS Ticker Still Not Showing Items (Dec 1, 2025 - Debug Session)

### Problem
Despite fixes to settings merging (Issue 5) and feed replacements (Issue 6), RSS items still not appearing in ticker. Only notes are visible.

### Root Cause Found
The broken feeds were **being synced back from the cloud server** via the sync service. Even after clearing local IndexedDB, the server's SQLite database still had the old broken feeds and would restore them.

### Solution: Auto-Cleanup on Startup
Added `cleanupBrokenFeeds()` method to `rssService.ts` that:
1. Runs once per session on first RSS fetch
2. Checks all feeds against a list of known broken feed names
3. Automatically removes any matches from IndexedDB

### Code Added to `services/rssService.ts`:
```typescript
// Known broken feed names to auto-remove
private readonly BROKEN_FEED_NAMES = [
    'GBHackers on Security',
    'Trustwave SpiderLabs',
    'KitPloit',
    'Volexity',
    'Sophos Naked Security',
    'SANS Penetration Testing',
    'Hacking Articles',
    'Packet Storm',
];

async cleanupBrokenFeeds(): Promise<number> {
    // Removes feeds matching BROKEN_FEED_NAMES
    // Returns count of removed feeds
}
```

### Result
- 8 broken feeds automatically removed on startup
- Console shows: `üóëÔ∏è Removed broken feed: [name]` for each
- Final count: `üì° RSS: 25/25 feeds loaded (0 temporarily unavailable)`

### Status: ‚úÖ RESOLVED

---

## Issue 8: Debug Logging (Dec 1, 2025)

### Purpose
Comprehensive logging added to trace RSS data flow for future troubleshooting.

### Log Points:
| Location | Message | Purpose |
|----------|---------|---------|
| `rssService.ts` | `üì° RSS loadSettings` | Shows IndexedDB settings |
| `RSSNewsTicker.tsx` | `üì° RSS Ticker settings` | Shows component props |
| `RSSNewsTicker.tsx` | `üì° RSS Ticker: fetched X items` | Shows fetch results |
| `RSSNewsTicker.tsx` | `üì° RSS Ticker: Item categories found` | Shows data categories |
| `RSSNewsTicker.tsx` | `üì° RSS Ticker: After category filter` | Shows filtering results |
| `RSSNewsTicker.tsx` | `üì° RSS Ticker MERGE` | Shows final ticker items |

### Status: ‚úÖ COMPLETE

---

## Version
**v4.1.4** - All fixes applied and tested.

### Version Files Updated:
- ‚úÖ `components/Sidebar.tsx` (line 481)
- ‚úÖ `package.json` (line 3)
- ‚úÖ `package-lock.json` (lines 3, 9)
- ‚úÖ `services/dbService.ts` (line 631)
- ‚úÖ `README.md` (badge)
- ‚úÖ `CHANGELOG.md`
- ‚úÖ `proxy_server.js` (line 55)
