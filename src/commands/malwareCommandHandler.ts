import { malwareHashService } from '../services/malware/malwareHashService';
import { malwareFileInfoService } from '../services/malware/malwareFileInfoService';
import { malwareStringsService } from '../services/malware/malwareStringsService';
import { malwareEntropyService } from '../services/malware/malwareEntropyService';
import { malwareHexdumpService } from '../services/malware/malwareHexdumpService';
import { iocExtractionService } from '../services/malware/iocExtractionService';
import { malwareQuarantineService } from '../services/malware/malwareQuarantineService';
import { malwareTestService } from '../services/malware/malwareTestService';
import { malwarePeAnalysisService } from '../services/malware/malwarePeAnalysisService';
import { malwareElfAnalysisService } from '../services/malware/malwareElfAnalysisService';
import { vmManagementService } from '../services/malware/vmManagementService';
import { metasploitService } from '../services/malware/metasploitService';
import { codeExecutionService } from '../services/codeExecutionService';

export class MalwareCommandHandler {
    async handleCommand(command: string): Promise<boolean> {
        const parts = command.trim().split(/\s+/);
        const cmd = parts[0];
        const args = parts.slice(1);
        const flags = args.filter(a => a.startsWith('--'));
        const cleanArgs = args.filter(a => !a.startsWith('--'));

        switch (cmd) {
            case '/malware-hash':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /malware-hash <file_path>"', 'bash');
                    return true;
                }
                await malwareHashService.calculateAllHashes(cleanArgs[0]);
                return true;

            case '/malware-fileinfo':
            case '/fileinfo':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /malware-fileinfo <file_path>"', 'bash');
                    return true;
                }
                await malwareFileInfoService.getFileInfo(cleanArgs[0]);
                return true;

            case '/malware-strings':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /malware-strings <file_path> [--urls|--ips|--emails]"', 'bash');
                    return true;
                }

                let filter: 'all' | 'urls' | 'ips' | 'emails' = 'all';
                if (flags.includes('--urls')) filter = 'urls';
                else if (flags.includes('--ips')) filter = 'ips';
                else if (flags.includes('--emails')) filter = 'emails';

                await malwareStringsService.extractStrings(cleanArgs[0], 4, filter);
                return true;

            case '/malware-entropy':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /malware-entropy <file_path>"', 'bash');
                    return true;
                }
                await malwareEntropyService.calculateEntropy(cleanArgs[0]);
                return true;

            case '/malware-hexdump':
            case '/hexdump':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /malware-hexdump <file_path> [lines]"', 'bash');
                    return true;
                }
                const lines = cleanArgs[1] ? parseInt(cleanArgs[1]) : 20;
                await malwareHexdumpService.getHexdump(cleanArgs[0], lines);
                return true;

            case '/ioc-extract':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /ioc-extract <file_path>"', 'bash');
                    return true;
                }
                await iocExtractionService.extractIOCs(cleanArgs[0]);
                return true;

            case '/malware-quarantine':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /malware-quarantine <file_path>"', 'bash');
                    return true;
                }
                await malwareQuarantineService.quarantineFile(cleanArgs[0]);
                return true;

            case '/malware-unquarantine':
            case '/malware-restore':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /malware-restore <hash_or_name>"', 'bash');
                    return true;
                }
                await malwareQuarantineService.restoreFile(cleanArgs[0]);
                return true;

            case '/malware-test-deploy':
                await malwareTestService.deployTestMalware();
                return true;

            case '/malware-test-run':
                await malwareTestService.runTestMalware();
                return true;

            case '/malware-pe':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /malware-pe <file_path>"', 'bash');
                    return true;
                }
                await malwarePeAnalysisService.analyzePe(cleanArgs[0]);
                return true;

            case '/malware-elf':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /malware-elf <file_path>"', 'bash');
                    return true;
                }
                await malwareElfAnalysisService.analyzeElf(cleanArgs[0]);
                return true;

            case '/vm-list':
                await vmManagementService.listVms();
                return true;

            case '/vm-start':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /vm-start <vm_name>"', 'bash');
                    return true;
                }
                await vmManagementService.startVm(cleanArgs[0]);
                return true;

            case '/vm-stop':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /vm-stop <vm_name>"', 'bash');
                    return true;
                }
                await vmManagementService.stopVm(cleanArgs[0]);
                return true;

            case '/msfconsole':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /msfconsole <command>"', 'bash');
                    return true;
                }
                const msfCmd = cleanArgs.join(' ');
                await metasploitService.runMsfCommand(msfCmd);
                return true;

            case '/msfvenom':
                if (cleanArgs.length < 1) {
                    await codeExecutionService.executeCode('echo "Usage: /msfvenom <options>"', 'bash');
                    return true;
                }
                const msfOpts = cleanArgs.join(' ');
                await metasploitService.generatePayload(msfOpts);
                return true;

            default:
                return false;
        }
    }
}

export const malwareCommandHandler = new MalwareCommandHandler();
