import { codeExecutionService } from '../codeExecutionService';

export class MalwareTestService {
    /**
     * Deploys "General Grievous" - a safe test malware file.
     * It mimics malware behavior (network calls, file creation) but is harmless.
     * Useful for testing the forensic tools.
     */
    async deployTestMalware(): Promise<void> {
        const pythonScript = `
import time
import os
import sys

def general_grievous():
    print("ü§ñ GENERAL GRIEVOUS: Hello There!")
    time.sleep(1)
    
    print("‚öîÔ∏è  Initializing lightsabers...")
    # Fake IOCs for extraction testing
    c2_server = "http://evil-separatist-base.com/order66"
    backup_ip = "192.168.66.99"
    contact_email = "count.dooku@sith-empire.org"
    
    print(f"üì° Contacting C2: {c2_server}")
    print(f"üì° Backup Link: {backup_ip}")
    print(f"üìß Sending report to: {contact_email}")
    
    # Create a "payload" file
    payload_path = "/tmp/grievous_payload.txt"
    with open(payload_path, "w") as f:
        f.write("You are a bold one!\\n")
        f.write(f"C2: {c2_server}\\n")
    
    print(f"üíæ Payload dropped: {payload_path}")
    print("üíÄ Coughing aggressively...")
    
if __name__ == "__main__":
    general_grievous()
`;

        const command = `
echo "üß™ DEPLOYING TEST MALWARE (General Grievous)"
echo "============================================"

# Create the python script
TARGET_FILE="/tmp/general_grievous.py"
cat << 'EOF' > "$TARGET_FILE"
${pythonScript}
EOF

echo "‚úÖ Created: $TARGET_FILE"
echo "‚ÑπÔ∏è  This is a SAFE test file. It prints text and creates a temp file."
echo "‚ÑπÔ∏è  Use forensic tools to analyze it:"
echo "   /malware-strings $TARGET_FILE"
echo "   /ioc-extract $TARGET_FILE"
echo "   /malware-hash $TARGET_FILE"
echo "============================================"
`;
        await codeExecutionService.executeCode(command, 'bash');
    }

    /**
     * Execute the test malware to generate traffic/artifacts
     */
    async runTestMalware(): Promise<void> {
        const command = `
echo "‚ñ∂Ô∏è  RUNNING TEST MALWARE"
echo "======================"
python3 /tmp/general_grievous.py
echo "======================"
`;
        await codeExecutionService.executeCode(command, 'bash');
    }
}

export const malwareTestService = new MalwareTestService();
