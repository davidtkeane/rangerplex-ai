import { codeExecutionService } from '../codeExecutionService';

export class VmManagementService {
    /**
     * List all available VMs using 'utmctl' (UTM) or 'VBoxManage' (VirtualBox).
     * Defaults to checking UTM first on macOS.
     */
    async listVms(): Promise<void> {
        const command = `
echo "üñ•Ô∏è  VIRTUAL MACHINE LIST"
echo "======================"

if command -v utmctl &> /dev/null; then
    echo "Hypervisor: UTM"
    echo "----------------------"
    utmctl list
elif command -v VBoxManage &> /dev/null; then
    echo "Hypervisor: VirtualBox"
    echo "----------------------"
    VBoxManage list vms
else
    echo "‚ùå No supported hypervisor CLI found (utmctl or VBoxManage)."
    echo "‚ÑπÔ∏è  Please install UTM (https://mac.getutm.app/) or VirtualBox."
fi
echo "======================"
`;
        await codeExecutionService.executeCode(command, 'bash');
    }

    /**
     * Start a VM by name/UUID
     */
    async startVm(vmName: string): Promise<void> {
        const command = `
echo "üöÄ STARTING VM: ${vmName}"
echo "======================"

if command -v utmctl &> /dev/null; then
    utmctl start "${vmName}"
    if [ $? -eq 0 ]; then echo "‚úÖ Command sent to UTM"; fi
elif command -v VBoxManage &> /dev/null; then
    VBoxManage startvm "${vmName}" --type headless
    if [ $? -eq 0 ]; then echo "‚úÖ Command sent to VirtualBox"; fi
else
    echo "‚ùå No hypervisor found."
fi
echo "======================"
`;
        await codeExecutionService.executeCode(command, 'bash');
    }

    /**
     * Stop a VM by name/UUID
     */
    async stopVm(vmName: string): Promise<void> {
        const command = `
echo "üõë STOPPING VM: ${vmName}"
echo "======================"

if command -v utmctl &> /dev/null; then
    utmctl stop "${vmName}"
elif command -v VBoxManage &> /dev/null; then
    VBoxManage controlvm "${vmName}" poweroff
else
    echo "‚ùå No hypervisor found."
fi
echo "======================"
`;
        await codeExecutionService.executeCode(command, 'bash');
    }

    /**
     * Create a snapshot (if supported)
     */
    async snapshotVm(vmName: string, snapshotName: string): Promise<void> {
        const command = `
echo "üì∏ CREATING SNAPSHOT: ${snapshotName}"
echo "Target VM: ${vmName}"
echo "======================"

if command -v VBoxManage &> /dev/null; then
    VBoxManage snapshot "${vmName}" take "${snapshotName}"
    echo "‚úÖ Snapshot created (VirtualBox)"
else
    echo "‚ö†Ô∏è  Snapshot management via CLI is limited for UTM."
    echo "‚ÑπÔ∏è  Please use the UTM GUI for snapshots."
fi
echo "======================"
`;
        await codeExecutionService.executeCode(command, 'bash');
    }
}

export const vmManagementService = new VmManagementService();
