import { codeExecutionService } from '../codeExecutionService';

export class MalwareElfAnalysisService {
    /**
     * Analyze Linux ELF files.
     * Requires 'pyelftools' python module.
     */
    async analyzeElf(filePath: string): Promise<void> {
        const pythonScript = `
import sys

try:
    from elftools.elf.elffile import ELFFile
    from elftools.elf.sections import SymbolTableSection
except ImportError:
    print("‚ùå Error: 'pyelftools' module not found.")
    print("‚ÑπÔ∏è  Please install it to use this feature:")
    print("   pip3 install pyelftools")
    sys.exit(1)

def analyze_elf(path):
    try:
        with open(path, 'rb') as f:
            elf = ELFFile(f)
            
            print(f"üêß ELF ANALYSIS REPORT")
            print(f"======================")
            print(f"File: {path}")
            print(f"Arch: {elf.get_machine_arch()}")
            print(f"Entry: {hex(elf.header['e_entry'])}")
            print(f"Type: {elf.header['e_type']}")
            
            # Sections
            print(f"\\n[Sections]")
            print(f"{'Name':<20} {'Type':<15} {'Size':<10}")
            print("-" * 50)
            for section in elf.iter_sections():
                name = section.name
                # Truncate long names
                if len(name) > 18: name = name[:15] + "..."
                print(f"{name:<20} {section['sh_type']:<15} {section['sh_size']:<10}")

            # Segments
            print(f"\\n[Segments]")
            print(f"{'Type':<15} {'VirtAddr':<12} {'MemSize':<10}")
            print("-" * 40)
            for segment in elf.iter_segments():
                print(f"{segment['p_type']:<15} {hex(segment['p_vaddr']):<12} {segment['p_memsz']:<10}")

            print("======================")
            
    except Exception as e:
        print(f"‚ùå Error loading ELF file: {e}")

if __name__ == "__main__":
    if len(sys.argv) > 1:
        analyze_elf(sys.argv[1])
    else:
        print("Usage: python3 elf_analyze.py <file>")
`;

        const command = `
echo "üîç STARTING ELF ANALYSIS..."

# Create temp script
cat << 'EOF' > /tmp/analyze_elf.py
${pythonScript}
EOF

# Run
python3 /tmp/analyze_elf.py "${filePath}"

# Cleanup
rm /tmp/analyze_elf.py
`;
        await codeExecutionService.executeCode(command, 'bash');
    }
}

export const malwareElfAnalysisService = new MalwareElfAnalysisService();
