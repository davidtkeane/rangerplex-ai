import { codeExecutionService } from '../codeExecutionService';

export class MalwareEntropyService {
    /**
     * Calculate Shannon Entropy of a file to detect packing/encryption.
     * Uses Python for calculation as it's standard on macOS/Linux.
     */
    async calculateEntropy(filePath: string): Promise<void> {
        // Python script to calculate entropy
        // We embed this directly into the bash command
        const pythonScript = `
import sys
import math

def shannon_entropy(data):
    if not data:
        return 0
    entropy = 0
    for x in range(256):
        p_x = float(data.count(bytes([x]))) / len(data)
        if p_x > 0:
            entropy += - p_x * math.log(p_x, 2)
    return entropy

try:
    with open(sys.argv[1], 'rb') as f:
        data = f.read()
        ent = shannon_entropy(data)
        
        # Create a visual bar
        bar_len = 20
        filled_len = int((ent / 8.0) * bar_len)
        bar = '‚ñà' * filled_len + '‚ñë' * (bar_len - filled_len)
        
        print(f"Entropy: {ent:.4f}")
        print(f"Visual:  [{bar}]")
        
        if ent > 7.2:
            print("Verdict: ‚ö†Ô∏è  HIGH ENTROPY (Likely Packed/Encrypted)")
        elif ent < 6.0:
            print("Verdict: ‚úÖ  LOW ENTROPY (Likely Plaintext/Native)")
        else:
            print("Verdict: ‚ùì  MEDIUM ENTROPY (Suspicious)")
            
except Exception as e:
    print(f"Error: {e}")
`;

        // Escape the python script for bash echo
        // Actually, it's safer to write it to a temp file and run it
        const command = `
echo "üé≤ MALWARE ENTROPY ANALYSIS"
echo "==========================="
echo "Target: ${filePath}"
echo ""

# Create temp python script
cat << 'EOF' > /tmp/calc_entropy.py
${pythonScript}
EOF

# Run it
python3 /tmp/calc_entropy.py "${filePath}"

# Cleanup
rm /tmp/calc_entropy.py

echo "==========================="
`;
        await codeExecutionService.executeCode(command, 'bash');
    }
}

export const malwareEntropyService = new MalwareEntropyService();
