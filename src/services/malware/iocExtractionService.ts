import { codeExecutionService } from '../codeExecutionService';

export class IocExtractionService {
    /**
     * Extract Indicators of Compromise (IOCs) from a file.
     * Looks for IPv4, URLs, Emails, and Domains.
     * Generates a summary report.
     */
    async extractIOCs(filePath: string): Promise<void> {
        // We'll use a Python script for more robust regex extraction than grep
        // and to format the output nicely as a report.
        const pythonScript = `
import sys
import re
import collections

def extract_iocs(filepath):
    iocs = {
        'ipv4': set(),
        'urls': set(),
        'emails': set(),
        'domains': set()
    }
    
    # Regex patterns
    # IPv4: Basic pattern, excludes 127.0.0.1 and 0.0.0.0 later
    pat_ip = re.compile(r'\\b(?:[0-9]{1,3}\\.){3}[0-9]{1,3}\\b')
    
    # URL: http/https
    pat_url = re.compile(r'https?://[\\w\\-\\.]+(?:/[\\w\\-./?%&=]*)?')
    
    # Email: standard simple
    pat_email = re.compile(r'[\\w\\.-]+@[\\w\\.-]+\\.\\w+')
    
    # Domain: slightly harder, looking for common TLDs
    # This is a heuristic, not perfect
    pat_domain = re.compile(r'\\b(?:[a-zA-Z0-9-]+\\.)+(?:com|net|org|io|gov|edu|co|uk|de|jp|cn|ru)\\b')

    try:
        with open(filepath, 'rb') as f:
            # Read line by line or chunks to handle large files
            # For simplicity in this script, we'll read all but treat as text with errors='ignore'
            content = f.read().decode('utf-8', errors='ignore')
            
            # Extract
            iocs['ipv4'].update(pat_ip.findall(content))
            iocs['urls'].update(pat_url.findall(content))
            iocs['emails'].update(pat_email.findall(content))
            iocs['domains'].update(pat_domain.findall(content))
            
            # Filter IPs (remove local/private if desired, but for now keep all except 0.0.0.0)
            iocs['ipv4'] = {ip for ip in iocs['ipv4'] if not ip.startswith('0.')}

    except Exception as e:
        print(f"Error reading file: {e}")
        return

    # Print Report
    print(f"IOC Extraction Report for: {filepath}")
    print("-" * 40)
    
    print(f"\\nüåê URLs Found ({len(iocs['urls'])}):")
    for item in sorted(list(iocs['urls']))[:10]:
        print(f"  - {item}")
    if len(iocs['urls']) > 10: print(f"  ... and {len(iocs['urls']) - 10} more")

    print(f"\\nüì° IPs Found ({len(iocs['ipv4'])}):")
    for item in sorted(list(iocs['ipv4']))[:10]:
        print(f"  - {item}")
    if len(iocs['ipv4']) > 10: print(f"  ... and {len(iocs['ipv4']) - 10} more")

    print(f"\\nüìß Emails Found ({len(iocs['emails'])}):")
    for item in sorted(list(iocs['emails']))[:10]:
        print(f"  - {item}")
    if len(iocs['emails']) > 10: print(f"  ... and {len(iocs['emails']) - 10} more")
    
    print("-" * 40)
    print("‚úÖ Extraction Complete")

if __name__ == "__main__":
    if len(sys.argv) > 1:
        extract_iocs(sys.argv[1])
    else:
        print("Usage: python3 ioc_extract.py <file>")
`;

        const command = `
echo "üõ°Ô∏è IOC EXTRACTION AGENT"
echo "======================="

# Create temp python script
cat << 'EOF' > /tmp/extract_iocs.py
${pythonScript}
EOF

# Run it
python3 /tmp/extract_iocs.py "${filePath}"

# Cleanup
rm /tmp/extract_iocs.py

echo "======================="
`;
        await codeExecutionService.executeCode(command, 'bash');
    }
}

export const iocExtractionService = new IocExtractionService();
