import { codeExecutionService } from '../codeExecutionService';

export class MalwareHashService {
    /**
     * Calculate multiple hashes for a file (MD5, SHA1, SHA256)
     * Useful for malware identification and VT lookup
     */
    async calculateAllHashes(filePath: string): Promise<void> {
        // We use a combined shell command for efficiency
        // This avoids spawning multiple processes if possible

        let command = '';

        if (window.electronAPI) {
            // If we have Electron, we can try to use it, but for now let's stick to shell for "All Hashes"
            // to ensure we get the output format we want in the terminal.
            // Or we can use the individual hash methods if we want to be cleaner.

            // Let's use shell for the "Report" style output
            command = `
echo "üîç MALWARE HASH REPORT"
echo "======================"
echo "File: ${filePath}"
echo ""
echo "MD5:    $(md5 -q "${filePath}")"
echo "SHA1:   $(shasum -a 1 "${filePath}" | awk '{print $1}')"
echo "SHA256: $(shasum -a 256 "${filePath}" | awk '{print $1}')"
echo "======================"
`;
        } else {
            // Fallback for web/other envs (might not work without backend)
            command = `
echo "üîç MALWARE HASH REPORT"
echo "File: ${filePath}"
md5 "${filePath}"
shasum -a 1 "${filePath}"
shasum -a 256 "${filePath}"
`;
        }

        await codeExecutionService.executeCode(command, 'bash');
    }

    /**
     * Calculate a specific hash
     */
    async calculateHash(filePath: string, algo: 'md5' | 'sha1' | 'sha256' | 'sha512'): Promise<string> {
        if (window.electronAPI) {
            try {
                const result = await window.electronAPI.calculateHash(filePath, algo);
                if (typeof result === 'object' && result.error) {
                    console.error('Electron hash error:', result.error);
                    return 'Error: ' + result.error;
                }
                return result as string;
            } catch (e) {
                console.error('Electron hash failed, falling back to shell', e);
            }
        }

        // Fallback to shell (this won't return the string to JS, just prints to terminal)
        // If we need the string in JS, we'd need a different mechanism or to parse the output.
        // For now, the requirement is mostly terminal output.

        const cmd = algo === 'md5' ? `md5 -q "${filePath}"` : `shasum -a ${algo === 'sha1' ? 1 : (algo === 'sha256' ? 256 : 512)} "${filePath}" | awk '{print $1}'`;
        await codeExecutionService.executeCode(`echo "Calculating ${algo}..." && ${cmd}`, 'bash');
        return 'Check terminal for output';
    }
}

export const malwareHashService = new MalwareHashService();
