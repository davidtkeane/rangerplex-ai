import { codeExecutionService } from '../codeExecutionService';
import { malwareHashService } from './malwareHashService';

export class MalwareQuarantineService {
    /**
     * Quarantine a suspicious file.
     * 1. Calculates hash
     * 2. Moves to quarantine folder (organized by date)
     * 3. Removes execute permissions
     * 4. Logs metadata
     */
    async quarantineFile(filePath: string): Promise<void> {
        // We use a bash script to handle the logic atomically on the host
        const script = `
FILE_PATH="${filePath}"
if [ ! -f "$FILE_PATH" ]; then
    echo "‚ùå Error: File not found: $FILE_PATH"
    exit 1
fi

# Setup Quarantine Directory
DATE_STR=$(date +%Y-%m-%d)
QUARANTINE_ROOT="./quarantine"
QUARANTINE_DIR="$QUARANTINE_ROOT/$DATE_STR"
mkdir -p "$QUARANTINE_DIR"

# Calculate Hash for ID
FILE_HASH=$(md5 -q "$FILE_PATH")
FILE_NAME=$(basename "$FILE_PATH")
DEST_PATH="$QUARANTINE_DIR/${FILE_HASH}_${FILE_NAME}"

# Create Metadata Log
LOG_FILE="$QUARANTINE_DIR/${FILE_HASH}_${FILE_NAME}.json"
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
USER=$(whoami)

cat << EOF > "$LOG_FILE"
{
  "originalPath": "$FILE_PATH",
  "fileName": "$FILE_NAME",
  "hash": "$FILE_HASH",
  "quarantinedAt": "$TIMESTAMP",
  "quarantinedBy": "$USER",
  "reason": "Manual Quarantine via RangerPlex"
}
EOF

# Move and Lock
mv "$FILE_PATH" "$DEST_PATH"
chmod 000 "$DEST_PATH" # Remove all permissions (lock it down)

echo "üîí QUARANTINE SUCCESSFUL"
echo "========================"
echo "File: $FILE_NAME"
echo "Hash: $FILE_HASH"
echo "Source: $FILE_PATH"
echo "Dest: $DEST_PATH"
echo "Log: $LOG_FILE"
echo "Permissions: Locked (000)"
echo "========================"
`;
        await codeExecutionService.executeCode(script, 'bash');
    }

    /**
     * Restore a file from quarantine using its hash (or partial filename)
     */
    async restoreFile(identifier: string): Promise<void> {
        const script = `
SEARCH_TERM="${identifier}"
QUARANTINE_ROOT="./quarantine"

# Find the file (matching hash or name)
FOUND_FILE=$(find "$QUARANTINE_ROOT" -type f -not -name "*.json" | grep "$SEARCH_TERM" | head -n 1)

if [ -z "$FOUND_FILE" ]; then
    echo "‚ùå Error: No quarantined file found matching '$SEARCH_TERM'"
    exit 1
fi

# Find corresponding log file
LOG_FILE="\${FOUND_FILE}.json"

if [ ! -f "$LOG_FILE" ]; then
    echo "‚ö†Ô∏è  Warning: Metadata log not found. Cannot determine original path."
    echo "File is at: $FOUND_FILE"
    echo "Please move it manually."
    exit 1
fi

# Read original path from log (using grep/sed hack since we might not have jq)
ORIG_PATH=$(grep -o '"originalPath": "[^"]*"' "$LOG_FILE" | cut -d'"' -f4)

if [ -z "$ORIG_PATH" ]; then
    echo "‚ùå Error: Could not parse original path from log."
    exit 1
fi

# Restore
DIR_NAME=$(dirname "$ORIG_PATH")
mkdir -p "$DIR_NAME"
mv "$FOUND_FILE" "$ORIG_PATH"
chmod 644 "$ORIG_PATH" # Restore read/write permissions (safe default)
rm "$LOG_FILE" # Remove log

echo "üîì RESTORE SUCCESSFUL"
echo "======================"
echo "Restored: $ORIG_PATH"
echo "From: $FOUND_FILE"
echo "Permissions: Restored (644)"
echo "======================"
`;
        await codeExecutionService.executeCode(script, 'bash');
    }
}

export const malwareQuarantineService = new MalwareQuarantineService();
