import { codeExecutionService } from '../codeExecutionService';

export class MalwareStringsService {
    /**
     * Extract strings from a binary file with optional filtering
     * Filters: 'all', 'urls', 'ips', 'emails'
     */
    async extractStrings(filePath: string, minLen: number = 4, filter: 'all' | 'urls' | 'ips' | 'emails' = 'all'): Promise<void> {
        let grepFilter = '';
        let header = 'ALL STRINGS';

        switch (filter) {
            case 'urls':
                // Regex for URLs (http/https)
                grepFilter = ' | grep -E "https?://[a-zA-Z0-9./?=_-]+"';
                header = 'EXTRACTED URLs';
                break;
            case 'ips':
                // Regex for IPv4 addresses
                grepFilter = ' | grep -E "[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}"';
                header = 'EXTRACTED IPs';
                break;
            case 'emails':
                // Simple regex for emails
                grepFilter = ' | grep -E "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}"';
                header = 'EXTRACTED EMAILS';
                break;
            default:
                grepFilter = '';
                break;
        }

        const command = `
echo "ðŸ”¤ MALWARE STRING ANALYSIS"
echo "========================"
echo "Target: ${filePath}"
echo "Filter: ${header}"
echo "Min Len: ${minLen}"
echo "------------------------"
strings -n ${minLen} "${filePath}"${grepFilter} | head -n 100
echo "------------------------"
echo "(Output truncated to first 100 results)"
echo "========================"
`;
        await codeExecutionService.executeCode(command, 'bash');
    }
}

export const malwareStringsService = new MalwareStringsService();
