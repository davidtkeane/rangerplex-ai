import { codeExecutionService } from '../codeExecutionService';

export class MalwarePeAnalysisService {
    /**
     * Analyze Windows PE (Portable Executable) files.
     * Requires 'pefile' python module.
     */
    async analyzePe(filePath: string): Promise<void> {
        const pythonScript = `
import sys
import datetime

try:
    import pefile
except ImportError:
    print("‚ùå Error: 'pefile' module not found.")
    print("‚ÑπÔ∏è  Please install it to use this feature:")
    print("   pip3 install pefile")
    sys.exit(1)

def analyze_pe(path):
    try:
        pe = pefile.PE(path)
    except Exception as e:
        print(f"‚ùå Error loading PE file: {e}")
        return

    print(f"üëæ PE ANALYSIS REPORT")
    print(f"=====================")
    print(f"File: {path}")
    print(f"Imphash: {pe.get_imphash()}")
    
    # Headers
    print(f"\\n[Headers]")
    print(f"Machine: {hex(pe.FILE_HEADER.Machine)}")
    print(f"Sections: {pe.FILE_HEADER.NumberOfSections}")
    print(f"Timestamp: {datetime.datetime.fromtimestamp(pe.FILE_HEADER.TimeDateStamp)}")
    
    # Sections
    print(f"\\n[Sections]")
    print(f"{'Name':<10} {'VirtualSize':<12} {'RawSize':<10} {'Entropy':<10}")
    print("-" * 45)
    for section in pe.sections:
        name = section.Name.decode().strip('\\x00')
        entropy = section.get_entropy()
        print(f"{name:<10} {hex(section.Misc_VirtualSize):<12} {hex(section.SizeOfRawData):<10} {entropy:.2f}")

    # Imports (Top 5 DLLs)
    if hasattr(pe, 'DIRECTORY_ENTRY_IMPORT'):
        print(f"\\n[Imports] (Top 5 DLLs)")
        for entry in pe.DIRECTORY_ENTRY_IMPORT[:5]:
            print(f"DLL: {entry.dll.decode()}")
            for imp in entry.imports[:3]:
                fname = imp.name.decode() if imp.name else "ordinal"
                print(f"  - {fname}")
            if len(entry.imports) > 3:
                print(f"  - ... and {len(entry.imports)-3} more")
    
    print("=====================")

if __name__ == "__main__":
    if len(sys.argv) > 1:
        analyze_pe(sys.argv[1])
    else:
        print("Usage: python3 pe_analyze.py <file>")
`;

        const command = `
echo "üîç STARTING PE ANALYSIS..."

# Create temp script
cat << 'EOF' > /tmp/analyze_pe.py
${pythonScript}
EOF

# Run
python3 /tmp/analyze_pe.py "${filePath}"

# Cleanup
rm /tmp/analyze_pe.py
`;
        await codeExecutionService.executeCode(command, 'bash');
    }
}

export const malwarePeAnalysisService = new MalwarePeAnalysisService();
