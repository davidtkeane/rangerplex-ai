import { codeExecutionService } from '../codeExecutionService';

export class MetasploitService {
    // Default Kali configuration (can be overridden or stored in settings later)
    private kaliUser = 'kali';
    private kaliHost = 'kali.local'; // Or IP address
    private sshKey = ''; // Optional path to identity file

    /**
     * Execute a Metasploit console command via SSH on the Kali VM.
     * Uses non-interactive mode (-x) to run single commands.
     */
    async runMsfCommand(msfCommand: string): Promise<void> {
        // Construct SSH command
        // We assume SSH keys are set up for passwordless login, or ssh-agent is running
        // If not, this might hang waiting for password, so we add a timeout or strict checking

        const remoteCmd = `msfconsole -q -x "${msfCommand}; exit"`;

        const command = `
echo "ü¶Å METASPLOIT REMOTE CONSOLE"
echo "Target: ${this.kaliUser}@${this.kaliHost}"
echo "Command: ${msfCommand}"
echo "============================"

# Check connectivity first
if ! ping -c 1 -W 1 ${this.kaliHost} &> /dev/null; then
    echo "‚ùå Error: Cannot reach Kali host (${this.kaliHost})"
    echo "‚ÑπÔ∏è  Ensure VM is running and network is bridged/shared."
    exit 1
fi

# Run SSH command
# -o BatchMode=yes fails if password is required (prevents hanging)
# -o ConnectTimeout=5
ssh -o BatchMode=yes -o ConnectTimeout=5 ${this.kaliUser}@${this.kaliHost} '${remoteCmd}'

if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå SSH Connection Failed."
    echo "‚ÑπÔ∏è  Ensure SSH is enabled on Kali and you have copied your public key:"
    echo "   ssh-copy-id ${this.kaliUser}@${this.kaliHost}"
fi
echo "============================"
`;
        await codeExecutionService.executeCode(command, 'bash');
    }

    /**
     * Generate a payload using msfvenom via SSH
     */
    async generatePayload(options: string): Promise<void> {
        const remoteCmd = `msfvenom ${options}`;

        const command = `
echo "üíâ MSFVENOM PAYLOAD GENERATOR"
echo "Target: ${this.kaliUser}@${this.kaliHost}"
echo "Options: ${options}"
echo "============================"

ssh -o BatchMode=yes -o ConnectTimeout=5 ${this.kaliUser}@${this.kaliHost} '${remoteCmd}' > payload.out

if [ $? -eq 0 ]; then
    echo "‚úÖ Payload generated successfully!"
    # Ideally we would SCP it back, but for now let's just say where it is or cat it if small
    echo "‚ÑπÔ∏è  Output captured to local file: payload.out"
else
    echo "‚ùå Generation Failed."
fi
echo "============================"
`;
        await codeExecutionService.executeCode(command, 'bash');
    }

    /**
     * Configure Kali connection details
     */
    setConfig(user: string, host: string) {
        this.kaliUser = user;
        this.kaliHost = host;
    }
}

export const metasploitService = new MetasploitService();
